# AMS 功能需求

## 整体架构特点

### 后端架构
- **单体集群架构**: 简化运维，避免分布式复杂性
- **多实例部署**: 通过 Hazelcast 实现集群内数据共享
- **水平扩展**: 支持按需增加实例应对流量峰值

### 前端架构  
- **React + Vite + TypeScript**: 现代化的前端技术栈
- **Ant Design**: 企业级UI组件库
- **开发/部署分离**: 开发时独立启动，生产打包到JAR中

---

## 后端核心功能 (P0)

### 1. 告警接入模块
- [ ] **多协议接入**: HTTP Webhook、gRPC、TCP Socket
- [ ] **标准化数据模型**: 统一告警数据结构
- [ ] **插件化适配器**: 支持不同告警源格式
- [ ] **流量控制**: 限流、熔断、降级保护
- [ ] **数据验证**: 格式、必填项、业务规则验证

### 1.5 晶圆厂设备接入模块 (半导体行业专用)
- [ ] **消息队列集成**: 
  - **Kafka/RabbitMQ/ActiveMQ** 支持 (通过EAP上报)
  - 设备告警通过消息队列异步接收
  - 支持批量告警处理和高并发场景
- [ ] **EAP集成数据模型**:
  - 设备状态监控 (E10, E40, E90等报警状态)
  - 工艺参数采集 (Recipe参数、SPC数据)
  - 故障代码解析 (Alarm Code, Error Code)
  - 维护事件跟踪 (PM, CM事件)
  - 晶圆批次跟踪 (Lot ID, Wafer ID)
- [ ] **半导体行业特性**:
  - Fab厂区、Area区域、Bay区域、Equipment设备层级结构
  - 设备类型分类 (Litho, Etch, Implant, Deposition, Metrology等)
  - 告警严重性分级 (Critical, Major, Minor, Info)
  - 设备可用性指标 (MTBF, MTTR, Uptime)
- [ ] **高可靠性设计**:
  - 消息队列消费者组，支持水平扩展
  - 消息确认机制 (ACK/NACK)，避免数据丢失
  - 死信队列处理，异常告警重新处理
  - 消息持久化，重启后不丢失
- [ ] **实时性能要求**:
  - 消息处理延迟 < 100ms (从MQ接收到入库)
  - 告警触发延迟 < 50ms (从接收到通知)
  - 支持同时处理 1000+ TPS 的告警消息
  - 支持批量处理，提高吞吐量

### 2. 告警处理引擎
- [ ] **告警持久化**: 存储到 PostgreSQL
- [ ] **告警去重合并**: 基于指纹的告警去重
- [ ] **告警优先级计算**: 基于规则和AI分析的优先级评估
- [ ] **告警状态管理**: 新建、确认、处理中、已解决、已关闭

### 3. 智能分析模块
- [ ] **AI告警分类**: 基于内容的自动分类
- [ ] **根因分析**: 识别告警的根本原因
- [ ] **相似告警识别**: 发现模式相似的告警
- [ ] **趋势预测**: 预测告警趋势和未来可能发生的问题
- [ ] **螺旋告警检测**: 同一问题反复触发告警的检测

### 4. 通知发送模块
- [ ] **多渠道支持**: 邮件、短信、钉钉、企业微信、Slack、Webhook
- [ ] **通知策略**: 基于告警级别和时间的发送策略
- [ ] **告警升级**: 长时间未处理的告警自动升级
- [ ] **通知模板**: 可配置的通知内容模板
- [ ] **发送记录追踪**: 通知发送状态和回执记录

### 5. 策略管理模块
- [ ] **告警规则引擎**: 基于条件的告警触发规则
- [ ] **静默规则**: 特定时间或条件下的告警静默
- [ ] **聚合规则**: 告警聚合减少告警风暴
- [ ] **路由规则**: 告警自动路由到指定处理人
- [ ] **升级规则**: 告警升级条件和流程

### 6. 多业务线/租户支持模块 (Multi-tenant Architecture)
- [ ] **业务线/租户隔离**:
  - 数据隔离: 告警、配置、用户数据按业务线隔离
  - 配置隔离: 每个业务线可独立配置告警策略
  - 权限隔离: 用户只能访问所属业务线的数据
- [ ] **策略插件化框架**:
  - **SPI (Service Provider Interface)** 机制: 允许不同业务线实现自定义策略
  - **策略扩展点**: 告警分类、优先级计算、路由规则、通知模板等可扩展
  - **插件热加载**: 无需重启即可加载新的策略插件
- [ ] **代码层策略定制**:
  - **策略接口定义**: 标准化的策略接口 (Strategy Pattern)
  - **业务线专属实现**: 每个业务线可实现自己的策略逻辑
  - **策略工厂模式**: 根据业务线动态选择合适的策略实现
- [ ] **前端策略配置**:
  - **业务线维度配置**: 每个业务线独立的管理界面
  - **策略模板库**: 可复用的策略模板，支持快速配置
  - **配置版本管理**: 每个业务线的配置版本控制和回滚
- [ ] **租户管理**:
  - **业务线注册**: 动态添加/删除业务线
  - **资源配额**: 每个业务线的告警数量、用户数量等配额管理
  - **计费管理**: 基于使用量的计费支持 (可选)

---

## 架构设计: 多业务线策略定制

### 策略插件化架构
```
策略接口层 (Interface)
├── AlarmClassificationStrategy      # 告警分类策略
├── PriorityCalculationStrategy      # 优先级计算策略  
├── RoutingStrategy                  # 路由策略
├── NotificationTemplateStrategy     # 通知模板策略
└── EscalationStrategy              # 升级策略

业务线实现层 (Implementation)
├── ITOpsStrategyPlugin            # IT运维业务线策略实现
├── FabStrategyPlugin              # 晶圆厂业务线策略实现
└── CustomBusinessStrategyPlugin   # 自定义业务线策略实现

策略工厂 (StrategyFactory)
└── 根据业务线ID动态加载对应的策略实现
```

### 前端配置架构
```
业务线配置管理
├── 全局管理员: 可以管理所有业务线
├── 业务线管理员: 只能管理自己业务线的配置
└── 普通用户: 只能查看和使用所属业务线的功能

策略配置界面
├── 代码插件管理: 上传/启用/禁用策略插件
├── 规则配置: 可视化规则编辑器
├── 模板配置: 通知模板、路由模板等
└── 测试与验证: 在线测试策略效果
```

### 数据隔离设计
```sql
-- 数据库表设计示例
alarms
├── id
├── tenant_id          -- 业务线ID (用于数据隔离)
├── alarm_data
└── ...

alarm_policies
├── id  
├── tenant_id          -- 业务线ID
├── policy_name
├── policy_config      -- JSON格式的配置
└── ...

users
├── id
├── tenant_id          -- 所属业务线
├── role               -- 角色 (全局管理员/业务线管理员/普通用户)
└── ...
```

---

## 前端Admin UI功能 (P0)

### 1. 告警大盘
- [ ] **实时告警列表**: 分页、筛选、排序
- [ ] **告警统计卡片**: 总数、今日新增、待处理、已解决
- [ ] **告警趋势图表**: 24小时告警趋势
- [ ] **告警分布**: 按来源、级别、状态分布
- [ ] **告警地图**: 地理分布的告警展示（如果有位置信息）

### 2. 告警管理
- [ ] **告警列表页**: 搜索、筛选、批量操作
- [ ] **告警详情页**: 完整信息、处理历史、相关告警
- [ ] **告警处理**: 确认、处理、解决、关闭操作
- [ ] **告警评论**: 处理过程中的评论和备注
- [ ] **告警关联**: 关联相关告警和工单

### 3. 业务线/租户管理 (新增)
- [ ] **业务线列表**: 查看所有业务线，支持搜索、筛选
- [ ] **业务线创建/编辑**: 创建新业务线或编辑现有业务线配置
- [ ] **业务线详情**: 查看业务线详情、状态、资源使用情况
- [ ] **策略插件管理**:
  - 上传/下载策略插件 (JAR文件)
  - 启用/禁用业务线专属策略插件
  - 插件版本管理和依赖检查
- [ ] **资源配额管理**:
  - 设置业务线的告警数量配额
  - 用户数量配额管理
  - 存储空间配额配置
  - 使用量统计和监控
- [ ] **配置继承与覆盖**:
  - 全局配置继承机制
  - 业务线专属配置覆盖
  - 配置优先级管理 (业务线 > 全局)

### 4. 策略配置
- [ ] **告警规则管理**: CRUD操作，启用/禁用 (按业务线隔离)
- [ ] **策略编辑器**: 可视化规则编辑界面 (支持业务线维度)
- [ ] **策略测试**: 在线测试规则效果 (可切换不同业务线环境)
- [ ] **策略版本**: 版本管理和回滚 (业务线独立版本)
- [ ] **策略导入导出**: 批量导入导出配置 (支持业务线筛选)

### 5. 通知配置
- [ ] **渠道管理**: 各通知渠道的配置
- [ ] **模板管理**: 通知模板的编辑和预览
- [ ] **发送策略**: 时间、频率、重试策略配置
- [ ] **接收组管理**: 告警接收组的配置

### 6. 系统管理 (多业务线增强版)
- [ ] **多业务线用户管理**:
  - 全局管理员: 可管理所有业务线的用户
  - 业务线管理员: 只能管理所属业务线的用户
  - 用户角色分配: 支持全局角色和业务线专属角色
  - 用户导入导出: 支持按业务线批量操作用户
- [ ] **多层级权限管理**:
  - **三层权限模型**:
    1. 全局权限 (Global): 系统级管理权限
    2. 业务线权限 (Tenant): 业务线级管理权限
    3. 功能权限 (Feature): 具体功能操作权限
  - **权限继承与覆盖**: 支持权限继承和业务线专属覆盖
  - **细粒度权限控制**: API级别、菜单级别、数据级别的权限控制
- [ ] **多租户系统设置**:
  - 全局系统参数: 所有业务线共享的基础配置
  - 业务线专属配置: 每个业务线可独立配置的参数
  - 配置优先级: 业务线配置 > 全局配置
- [ ] **审计日志与监控**:
  - 多维度操作日志: 记录用户、业务线、操作类型等信息
  - 业务线隔离的日志查询: 用户只能查看所属业务线的日志
  - 多租户监控指标: 按业务线统计系统性能和使用量

### 6.1 角色定义（已实现）
- [x] 角色分页查询：支持 `page/size/keyword`
- [x] 角色创建：支持 `permissionIds` 绑定
- [x] 角色编辑：支持权限回填和重分配
- [x] 角色删除：被用户引用时返回业务错误
- [x] 角色管理页：`/admin/roles` 已接入查询、弹窗、权限多选与删除确认
- [x] 多租户隔离：角色相关系统实体启用全局 `tenant-filter`

---

## 后端高级功能 (P1)

### 1. 性能优化
- [ ] **多级缓存**: Hazelcast分布式缓存 + 本地缓存
- [ ] **异步处理**: 告警处理的异步化
- [ ] **批量操作**: 批量入库和批量通知
- [ ] **连接池优化**: 数据库和外部连接优化

### 2. 可靠性增强
- [ ] **集群管理**: 节点发现、心跳检测、故障转移
- [ ] **数据备份**: 自动备份和恢复机制
- [ ] **监控告警**: 系统自身的监控和告警
- [ ] **容错处理**: 降级、熔断、自动恢复

### 3. 可观测性
- [ ] **指标采集**: Micrometer集成各种指标
- [ ] **分布式追踪**: OpenTelemetry/Zipkin集成
- [ ] **日志聚合**: 结构化日志和日志分析
- [ ] **健康检查**: 应用和组件健康状态

### 4. AI能力增强
- [ ] **多模型支持**: 支持多种LLM提供商
- [ ] **本地模型部署**: Ollama本地模型支持
- [ ] **模型微调**: 基于历史数据的模型优化
- [ ] **AI结果验证**: 人工反馈改进AI准确性

---

## 前端高级功能 (P1)

### 1. 用户体验优化
- [ ] **实时更新**: WebSocket实现告警实时推送
- [ ] **离线支持**: PWA支持离线访问
- [ ] **快捷键**: 键盘快捷键提升操作效率
- [ ] **深色模式**: 主题切换支持
- [ ] **国际化**: 多语言支持

### 2. 数据可视化增强
- [ ] **自定义仪表盘**: 可配置的告警仪表盘
- [ ] **图表类型丰富**: 多种图表展示数据
- [ ] **数据导出**: CSV、Excel、PDF导出
- [ ] **大屏模式**: 专门的大屏展示模式

### 3. 协作功能
- [ ] **团队协作**: 告警分配和团队协作
- [ ] **协同处理**: 多人同时处理同一告警
- [ ] **工作流**: 可配置的告警处理工作流
- [ ] **知识库**: 告警处理经验和解决方案

### 4. 移动端支持
- [ ] **响应式设计**: 支持手机和平板访问
- [ ] **移动App**: 可选的移动端应用
- [ ] **推送通知**: 移动端推送通知
- [ ] **离线处理**: 移动端离线处理能力

---

## 扩展功能 (P2)

### 1. 集成能力
- [ ] **第三方系统集成**: 与ITSM、CMDB等系统集成
- [ ] **Webhook触发**: 告警触发外部系统Webhook
- [ ] **API网关集成**: 与企业API网关集成
- [ ] **单点登录**: LDAP、OAuth2、SAML支持

### 2. 多租户支持
- [ ] **租户隔离**: 数据、配置、权限隔离
- [ ] **配额管理**: 各租户的资源配额
- [ ] **租户管理**: 租户创建、配置、计费

### 3. 自动化运维
- [ ] **自动处理规则**: 自动化的告警处理
- [ ] **预案管理**: 标准化的处理预案
- [ ] **演练功能**: 告警处理演练
- [ ] **复盘分析**: 告警处理的复盘和优化

### 4. 高级分析
- [ ] **告警根因分析**: 基于拓扑和指标的根因定位
- [ ] **影响范围分析**: 告警影响的业务范围分析
- [ ] **预防性告警**: 基于预测的预防性告警
- [ ] **成本分析**: 告警处理的成本效益分析

---

## 非功能需求

### 性能需求
- 告警接入延迟: < 50ms (P95)
- 告警处理延迟: < 100ms (P95)
- 页面加载时间: < 2s (首屏)
- 支持并发告警数: > 10,000 TPS
- 支持用户数: > 100 并发用户

### 可靠性需求
- 系统可用性: > 99.9%
- 数据持久化: > 99.999%
- 故障恢复时间: < 5分钟
- 备份恢复时间: < 30分钟

### 安全性需求
- 数据加密: 传输和存储加密
- 访问控制: 基于角色的权限控制
- 审计日志: 所有操作可追溯
- 安全认证: JWT、OAuth2支持

### 可维护性需求
- 代码覆盖率: > 80%
- 文档完整性: API文档、部署文档
- 监控覆盖: 关键指标全覆盖
- 自动化部署: CI/CD流水线

---

## 优先级说明

### P0 - 核心功能 (MVP)
- 告警的基本生命周期管理
- 基础的通知渠道
- 核心的Admin UI功能
- 必须满足的SLA要求

### P1 - 增强功能
- 提升用户体验和性能
- 增加系统可靠性
- 丰富AI能力
- 在前6个月内完成

### P2 - 扩展功能
- 企业级特性
- 高级集成能力
- 可选的高级功能
- 在12个月内完成

---

## 版本规划

### v1.0.0 (MVP)
- 基本告警接入和处理
- 基础通知渠道（邮件、钉钉）
- Admin UI基础功能
- 单节点部署支持

### v1.1.0
- 集群部署支持
- AI分析能力
- 更多通知渠道
- 前端性能优化

### v1.2.0
- 高级策略引擎
- 可观测性增强
- 移动端优化
- 第三方集成

### v2.0.0
- 多租户支持
- 高级自动化
- 企业级安全
- 云原生部署

---

## 技术约束

### 架构约束
- ❌ 禁止创建微服务拆分（保持单体）
- ✅ 多模块设计（Gradle多模块）
- ✅ 集群内状态共享（通过Hazelcast）
- ✅ 前端打包到JAR中部署

### 技术栈约束
- ✅ Java后端（JDK 25）
- ✅ React前端（TypeScript + Vite）
- ✅ PostgreSQL数据库（兼容Oracle）
- ✅ Hazelcast分布式缓存

### 质量约束
- ✅ 必须通过所有测试
- ✅ 必须通过代码质量检查
- ✅ 必须支持容器化部署
- ✅ 必须提供完整的监控
