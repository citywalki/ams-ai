databaseChangeLog:
  - changeSet:
      id: add-user-management-menu
      author: system
      comment: "添加用户管理菜单和相关权限"
      changes:
        - sql:
            dbms: postgresql
            sql: |
              INSERT INTO menus (id, tenant_id, key, label, route, parent_id, icon, sort_order, is_visible, menu_type, roles_allowed, created_at, updated_at)
              SELECT 
                (SELECT COALESCE(MAX(id), 0) + 1 FROM menus),
                1,
                'admin:users',
                '用户管理',
                '/admin/users',
                (SELECT id FROM menus WHERE key = 'settings' AND tenant_id = 1 LIMIT 1),
                'UserOutlined',
                40,
                true,
                'MENU',
                '["ADMIN"]'::jsonb,
                CURRENT_TIMESTAMP,
                CURRENT_TIMESTAMP
              WHERE NOT EXISTS (SELECT 1 FROM menus WHERE key = 'admin:users' AND tenant_id = 1);
        
        - sql:
            dbms: postgresql
            sql: |
              INSERT INTO permissions (id, code, name, description, tenant_id, menu_id, sort_order, button_type, created_at, updated_at)
              SELECT 
                (SELECT COALESCE(MAX(id), 0) + 1 FROM permissions),
                'admin:users',
                '用户管理',
                '管理系统用户，包括创建、编辑、删除用户和分配角色',
                1,
                (SELECT id FROM menus WHERE key = 'admin:users' AND tenant_id = 1 LIMIT 1),
                1,
                'DEFAULT',
                CURRENT_TIMESTAMP,
                CURRENT_TIMESTAMP
              WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code = 'admin:users' AND tenant_id = 1);
        
        - sql:
            dbms: postgresql
            sql: |
              INSERT INTO role_permissions (role_id, permission_id)
              SELECT r.id, p.id
              FROM roles r, permissions p
              WHERE r.code = 'ADMIN' 
                AND r.tenant_id = 1
                AND p.code = 'admin:users'
                AND p.tenant_id = 1
                AND NOT EXISTS (
                  SELECT 1 FROM role_permissions rp 
                  WHERE rp.role_id = r.id AND rp.permission_id = p.id
                );

      rollback:
        - sql:
            dbms: postgresql
            sql: |
              DELETE FROM role_permissions 
              WHERE permission_id IN (SELECT id FROM permissions WHERE code = 'admin:users');
              DELETE FROM permissions WHERE code = 'admin:users';
              DELETE FROM menus WHERE key = 'admin:users';
